# 使用视频画面拼接自定义的字幕

- [前言](#前言)
- [效果](#效果)
- [技术分析](#技术分析)
  - [裁剪视频画面](#裁剪视频画面)
  - [绘制文字](#绘制文字)
  - [截取指定时间点的画面](#截取指定时间点的画面)
  - [将多个画面垂直堆叠](#将多个画面垂直堆叠)
  - [快速定位到开始时间点](#快速定位到开始时间点)
- [关于运行效率](#关于运行效率)

## 前言

网络上经常可以看到一些“截图某一张视频画面，并把后续字幕连续拼接在一起”的图片，可以快速传递视频内的内容。  
当然，这很容易造假。所以当你看到类似内容的时候，需要自行判断。  
这个脚本，就是用来实现这个功能的。需要说明的是，这个脚本不是为了造假而生的，仅仅是出于娱乐与交流的目的。  

## 效果

![效果图](imgs/subtitle.stack.demo.jpg)

> 这是“Kung.Fu.Panda.4”`7:38.416`开始的画面，并间隔10秒截取一个字幕区。内容当然是我自己编写的。

## 技术分析

### 裁剪视频画面

使用`crop`过滤器，[官方文档](https://ffmpeg.org/ffmpeg-filters.html#crop)。  
其中第一帧是完整的画面，后续的是截取底下一部分画面（可通过-sh控制要截取的比例）。  

在代码中，我使用了取巧的方式，例如当sh=0.2（20%）时，把第一帧画面设置为第一帧高度的80%，剩下的20%和后续所有帧一样用同样的截取和绘制文字的代码，省去了判断是否第一帧的逻辑。

关键命令：
```js
// 第一帧上部分
crop=w=iw:h=ih-ih*${cropH}:x=0:y=0
// 后续字幕部分
crop=w=iw:h=ih*${cropH}:x=0:y=ih-oh
```

### 绘制文字

使用`drawtext`过滤器，[官方文档](https://ffmpeg.org/ffmpeg-filters.html#drawtext-1)。  
ffmpeg支持各种字幕格式文件，不过为了时间精准，也为了避免在脚本里解析字幕文件，于是采用绘制文字的方式。  

其中，让文字在画面水平居中和垂直居中，用的命令是`x=(w-tw)/2:y=(h-th)/2`，  
多行文字时，默认两行文字是左对其的，要让其居中对齐，则用`text_align=center+middle`，  
如果不指定`fontfile`，ffmpeg支持通过`fontconfig`来指定字体的配置，但是配置起来比较麻烦且缺少灵活性，所以还是指定`fontfile`参数，这个需要传递字体文件的完整路径，而且，在windows下，路径需要使用`/`而不能用`\`，如果路径包含空格则需要用单引号包围，例如`fontfile='c:/my fonts/cn/demo.ttf'`。

### 截取指定时间点的画面

使用`trim`过滤器，[官方文档](https://ffmpeg.org/ffmpeg-filters.html#trim)。  
因为不能只截取一帧，所以指定`duration=0.01`。如果不指定duration的话会增加内存占用及cpu消耗。  

### 将多个画面垂直堆叠

使用`vstack`过滤器，[官方文档](https://ffmpeg.org/ffmpeg-filters.html#vstack-1)。

### 快速定位到开始时间点

在`-i <input>`之前，通过`-ss`指定开始时间点，ffmpeg将使用解析关键帧的方式快速定位到该时间点，而不用解码所有帧。

## 关于运行效率

因为使用-ss，所以开始时间不会限制效率，最影响效率的是你输入的文本的行数。  
以上面的示例图片为准，在我的电脑上运行是1.4秒，CPU占用率极低。仅供参考。